---
import Loading from "@/components/Loading.astro";
import logo from "../_assets/logo.webp";
import Footer from "../_components/Footer.astro";
import H2 from "../_components/H2.astro";
import Header from "../_components/Header.astro";
import Layout from "../_components/Layout.astro";
import Menu from "../_components/Menu.astro";
import Note from "../_components/Note.astro";
---

<Layout title="Share Your Photo - 2025 第56回JBBF全国青年フェローシップキャンプ" favicon={logo.src}>
  <Header />

  <main class="main bubble">
    <H2>
      <span slot="en">Share Your Photo</span>
      <span slot="ja">写真を共有</span>
    </H2>

    <section class="section">
      <form
        class="form"
        x-data="{ status: '' }"
        @submit="status = 'submitting'"
        @submitted="status = ''"
      >
        <p>
          キャンプの思い出の写真をご投稿いただき、みなさまと心温まるひとときを分かち合いましょう。
        </p>

        <Note>
          このサイトは教会関係者のみに共有されますが、個人を特定できる情報などは写り込まないよう、ご注意をお願いいたします。
        </Note>

        <label for="church-name-input" class="label-text">
          <span class="visually-hidden">教会名</span>
          <input
            id="church-name-input"
            type="text"
            class="input-text"
            placeholder="教会名"
            aria-label="教会名を入力してください"
            required
          />
        </label>

        <div class="label-file">
          <label for="image-upload-input" class="notice-file">
            アップロードしたい画像を選択してください。画像は1度に10枚まで選択できます。
          </label>

          <input
            id="image-upload-input"
            type="file"
            class="input-file"
            accept="image/jpeg,image/png,image/webp"
            multiple
            required
            aria-label="画像ファイルを選択(JPEG、PNG、WebP形式、最大10枚)"
            aria-describedby="file-upload-description"
          />

          <div id="file-upload-description" class="visually-hidden">
            JPEG、PNG、WebP形式の画像を最大10枚まで選択できます。各ファイルは10MB以下である必要があります。
          </div>
        </div>

        <button type="submit" class="upload-button" :disabled="status === 'submitting'">
          Upload
        </button>

        <template x-if="status === 'submitting'" x-transition>
          <Loading />
        </template>
      </form>
    </section>
  </main>

  <Footer href="/2025/05/album/" />
  <Menu />
</Layout>

<style is:global>
  body .viewport {
    background: var(--color-text);
    color: var(--color-background);
  }
</style>

<style>
  .main {
    overflow: hidden;
    position: relative;
  }

  .section {
    margin: auto;
    max-width: 600px;
    padding: 0 1em;
  }

  .label-text {
    background: var(--color-background);
    color: var(--color-text);
    border-radius: 4px;
    display: block;
    margin: 2em auto 1em;
    padding: 1em;
  }

  .input-text {
    width: 100%;
  }

  .label-file {
    border: currentColor solid 1px;
    border-radius: 4px;
    cursor: pointer;
    display: block;
    margin: 1em auto;
    padding: 1em;
  }

  .notice-file {
    font-size: 85%;
    margin: 0 0 1.5em;
  }

  .upload-button {
    background: inherit;
    border: currentColor solid 1px;
    border-radius: 4em;
    color: inherit;
    cursor: pointer;
    display: block;
    font-size: 125%;
    margin: 2em auto;
    padding: 1em 1.5em;
  }

  .upload-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>

<script src="../_scripts/bubble.ts"></script>
<script
  is:inline
  src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"
  integrity="sha384-JqFoqlF3F5xqGzaQZV5hY8pK9PxFQhvL5TJ7FpJz7OJL2g/f0aZ6rKXa4Mf4qYHb"
  crossorigin="anonymous"
  defer></script>
<script>
  import { uploadImages } from "@/scripts/uploadImages";
  import { sanitizeFileName } from "@/scripts/sanitizeFileName";
  import { ENDPOINT_UPLOAD_IMAGES } from "../_config/endpoints";

  const $ = (selector: string) => document.querySelector(selector);
  const form = $(".form") as HTMLFormElement;
  const inputFile = $("#image-upload-input") as HTMLInputElement;
  const inputText = $("#church-name-input") as HTMLInputElement;
  const MAX_FILES = 10;

  inputFile.addEventListener("change", () => {
    if (inputFile.files && inputFile.files.length > MAX_FILES) {
      alert(`画像は${MAX_FILES}枚まで選択できます。`);
      inputFile.value = "";
    }
  });

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    if (!inputFile.files || inputFile.files.length === 0) {
      alert("画像を選択してください。");
      return;
    }

    const files = Array.from(inputFile.files);

    // 教会名のサニタイズ(tryでエラーハンドリング)
    let sanitizedName: string;
    try {
      sanitizedName = sanitizeFileName(inputText.value);
    } catch (error) {
      alert(error instanceof Error ? `教会名が不正です: ${error.message}` : "教会名が不正です");
      return;
    }

    // パス構築(年度を動的に取得)
    const currentYear = new Date().getFullYear();
    const path = `youth-fellowship-camp-${currentYear}/photo-gallery/${sanitizedName}/`;

    // タイムスタンプ生成
    const timestamp = new Date().toISOString().replace(/[-:.]/g, "");

    // ファイル名のサニタイズと再構築
    const newFiles = files.map((file) => {
      try {
        // 拡張子を取得
        const extensionMatch = file.name.match(/\.([^.]+)$/);
        const extension = extensionMatch ? extensionMatch[1] : "";

        // ファイル名本体をサニタイズ
        const baseName = file.name.replace(/\.[^.]+$/, "");
        const sanitizedBaseName = sanitizeFileName(baseName);

        // 新しいファイル名
        const newName = `${timestamp}-${sanitizedBaseName}${extension ? "." + extension : ""}`;

        return new File([file], newName, { type: file.type });
      } catch {
        throw new Error(`ファイル名 "${file.name}" の処理に失敗しました`);
      }
    });

    try {
      const resp = await uploadImages({ images: newFiles, path }, ENDPOINT_UPLOAD_IMAGES);

      if (resp.status === "success") {
        alert("アップロードに成功しました");
        // フォームをリセット
        inputFile.value = "";
        inputText.value = "";
      } else {
        // エラーメッセージをより具体的に表示
        alert(
          `アップロードに失敗しました\n\n${resp.message}\n\n恐れ入りますが、再度お試しください`
        );
      }
    } catch (err) {
      console.error("Upload error:", err);
      alert(
        `アップロード中にエラーが発生しました\n\n${
          err instanceof Error ? err.message : "不明なエラー"
        }\n\n恐れ入りますが、再度お試しください`
      );
    }

    setTimeout(() => {
      form.dispatchEvent(new CustomEvent("submitted"));
    }, 100);
  });
</script>
